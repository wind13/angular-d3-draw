/*! angular-d3-draw 2014-10-27 */
!function(){"use strict";angular.module("angular-d3-draw",[]).directive("svgAdaptor",function(){return{restrict:"E",transclude:!0,scope:{svgid:"@"},controller:function(a){this.svg=a.svg=d3.select("#"+a.svgid),this.gid=function(b){return a.svgid+"-"+b},this.find=function(a){return d3.select("#"+this.gid(a))},this.group=function(b,c,d){var e=a.svg.append("g");return e.attr("id",b).attr("transform","translate("+c+","+d+")"),e},this.watchAttrs=function(a,b,c,d){angular.forEach(c,function(c,e){e.indexOf("$")<0&&b.$watch(e,function(c,f){d(a,b,e,c,f)})})},this.setAttrs=function(a,b,c,d){var e=d;"id"===c&&(e=a.gid(d)),a.find(b.id).attr(c,e)},this.markerArrow=function(b,c){var d=a.svg.append("marker");d.attr("id",this.gid(b)),d.attr("viewBox","0 0 10 10"),d.attr("refX","0"),d.attr("refY","5"),d.attr("fill",c),d.attr("markerUnits","strokeWidth"),d.attr("markerWidth","8"),d.attr("markerHeight","6"),d.attr("orient","auto");var e=d.append("path");return e.attr("d","M 0 0 L 10 5 L 0 10 z"),d}},link:function(){}}}).directive("rectText",function(){return{restrict:"E",transclude:!0,require:"^svgAdaptor",scope:{id:"@",text:"@",width:"@",height:"@",x:"@",y:"@",rx:"@",ry:"@",style:"@",textClass:"@",rectClass:"@"},controller:function(a){a.MIN_FONT_SIZE=12,a.MAX_FONT_SIZE=48,a.PADDING=10,a.calculateLineHeight=function(a){var b,c,d,e=parseInt($(a).css("line-height"),10);return isNaN(e)&&(b=a.cloneNode(),b.innerHTML="<br>",a.appendChild(b),c=b.offsetHeight,b.innerHTML="<br><br>",d=b.offsetHeight,a.removeChild(b),e=d-c),e}},link:function(a,b,c,d){var e=d.group(a.id,a.x,a.y),f=e.append("rect");f.attr("id",e.attr("id")+"rect"),f.attr("rx",c.rx),f.attr("ry",c.ry),f.attr("width",c.width),f.attr("height",c.height),f.attr("style",c.style),f.attr("class","rectStyle "+c.rectClass);var g=e.append("foreignObject");g.attr("width",c.width),g.attr("height",c.height);var h=g.append("xhtml:style");h.text(".rectText { text-align: center; padding: "+a.PADDING+"px; box-sizing: border-box;} .rectStyle { fill: #f60; stroke: black; stroke-width: 5; opacity: 0.3 }");var i=g.append("xhtml:div");i.attr("id",e.attr("id")+"text"),i.attr("class","rectText "+c.textClass),i.attr("title",c.text),i.attr("data-fittext",""),i.text(c.text),a.$watch("text",function(b){var c=d3.select("#"+a.id+"text");c.style({overflow:"display",height:"auto"}),c.text(b);var d=parseInt(f.attr("height"));if(""===b)return void c.style({"font-size":d/2+"px","line-height":d+"px",overflow:"hidden",height:d+"px"});var e,g,h=$(i[0]).height()+2*a.PADDING,j=a.calculateLineHeight(i[0][0]),k=parseInt($(i[0]).css("font-size"));if(console.log(h+" vs "+d),h>0&&d>0&&j>0&&k>0){for(e=Math.max(k,a.MIN_FONT_SIZE),e=Math.min(e,a.MAX_FONT_SIZE),g=Math.min(j,d-2*a.PADDING),g=Math.max(g,k),(e!=k||g!=j)&&(c.style({"font-size":e+"px","line-height":g+"px"}),h=$(i[0]).height()+2*a.PADDING);d>h;)e>=a.MAX_FONT_SIZE||1.5*e>g?(g+=1,c.style({"line-height":g+"px"})):(e+=1,c.style({"font-size":e+"px"})),h=$(i[0]).height()+2*a.PADDING;for(;h>d;)1.5*e>=g&&e>a.MIN_FONT_SIZE?(e-=1,c.style({"font-size":e+"px"})):g<=a.MIN_FONT_SIZE?c.style({overflow:"hidden",height:d+"px"}):(g-=1,c.style({"line-height":g+"px"})),h=$(i[0]).height()+2*a.PADDING;h!=d&&(g=Math.max(a.MIN_FONT_SIZE,d/(h/g)),c.style({overflow:"hidden","line-height":g+"px",height:d+"px"}))}c.attr("title",b)})}}}).directive("rightRoundedRect",function(){return{restrict:"E",transclude:!1,require:"^svgAdaptor",scope:{id:"@",width:"@",height:"@",x:"@",y:"@",radius:"@",style:"@","class":"@"},controller:function(a){a.rightRoundedRect=function(a,b,c,d,e){return"M"+a+","+b+"h"+(c-e)+"a"+e+","+e+" 0 0 1 "+e+","+e+"v"+(d-2*e)+"a"+e+","+e+" 0 0 1 "+-e+","+e+"h"+(e-c)+"z"},a.setAttrs=function(b,c,d,e){var f=b.find(c.id);switch(d){case"id":f.attr(d,b.gid(e));break;case"style":case"class":f.attr(d,e);break;default:f.attr("d",a.rightRoundedRect(c.x,c.y,c.width,c.height,c.radius))}}},link:function(a,b,c,d){var e=d.svg.append("path");e.attr("id",d.gid(c.id)),d.watchAttrs(d,a,c,a.setAttrs)}}}).directive("linkArrow",function(){return{restrict:"E",transclude:!1,require:"^svgAdaptor",scope:{id:"@",x1:"@",y1:"@",x2:"@",y2:"@",stroke:"@",strokeWidth:"@",title:"@","class":"@"},controller:function(){},link:function(a,b,c,d){var e=d.markerArrow(c.id+"-arrow",c.stroke),f=d.svg.append("line");f.attr("id",d.gid(c.id)),f.attr("marker-end","url(#"+e.attr("id")+")"),d.watchAttrs(d,a,c,d.setAttrs)}}}).directive("svgHere",function(){return{restrict:"EA",transclude:!0,replace:!0,scope:{id:"@",width:"@",height:"@"},controller:function(a){a.svg=d3.select("#"+a.id),a.svg.append("circle").attr("cx","50").attr("cy","40").attr("r","20")},template:'<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',link:function(a){a.svg=d3.select("#"+a.id),a.svg.append("circle").attr("cx","50").attr("cy","40").attr("r","20")}}}).directive("circleTest",function(){return{restrict:"E",replace:!0,template:'<rect x="5" y="5" width="20" height="20" class="ng-scope"></rect>'}})}();